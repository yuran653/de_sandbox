#!/usr/sbin/nft -f

# Flush existing ruleset to start clean
flush ruleset

# Define public interface (eth0), OpenVPN interface (tun0), subnet (10.10.0.0/24), and port (1194)
define PUB_IF      = "eth0"
define WG_IF       = "tun0"
define WG_SUBNET   = 10.10.0.0/24
define WG_PORT     = 1194

# Filter table for packet filtering rules
table inet filter {

    # Input chain: Controls incoming traffic to the host
    chain input {
        type filter hook input priority 0;
        policy drop;

        # Drop invalid connection states
        ct state invalid drop

        # Allow loopback traffic
        iif "lo" accept
        # Allow established and related traffic
        ct state established,related accept
        # Allow all traffic from DO private network
        ip saddr 10.104.0.0/20 accept


        # Rate-limit new SSH connections from public interface to prevent brute-force
        iif $PUB_IF tcp dport 22 ct state new limit rate 6/minute accept
        # Drop excess new SSH connections
        iif $PUB_IF tcp dport 22 ct state new drop
        
        # Allow WireGuard UDP traffic on specified port
        iif $PUB_IF udp dport $WG_PORT accept

        # Allow all traffic from WireGuard subnet
        ip saddr $WG_SUBNET accept

        # Default drop for unmatched traffic
        drop
    }

    # Forward chain: Controls traffic forwarding between interfaces
    chain forward {
        type filter hook forward priority 0;
        policy drop;

        # Drop invalid connection states
        ct state invalid drop

        # Allow return traffic for established/related connections
        ct state established,related accept

        # Allow VPN traffic to host/internet
        iifname $WG_IF oifname $PUB_IF accept
        # Allow subnet traffic to internet
        ip saddr $WG_SUBNET oifname $PUB_IF accept

        # Allow VPN clients to reach VPSs inside 10.104.0.0/20
        iifname $WG_IF ip daddr 10.104.0.0/20 accept

        # Allow Docker networks to internet
        iifname "docker0" oifname $PUB_IF accept
        iifname "br-*"    oifname $PUB_IF accept

        # Default drop for unmatched traffic
        drop
    }

}

# NAT table for network address translation
table ip nat {
    # Postrouting chain: Applies NAT to outgoing traffic
    chain postrouting {
        type nat hook postrouting priority srcnat;
        policy accept;

        # Do NOT masquerade traffic WG â†’ local 10.104.0.0/20
        ip saddr $WG_SUBNET ip daddr 10.104.0.0/20 oifname $PUB_IF accept

        # Masquerade VPN subnet traffic to internet
        ip saddr $WG_SUBNET oifname $PUB_IF masquerade

        # Masquerade Docker subnet traffic to internet
        ip saddr 172.17.0.0/16 oifname $PUB_IF masquerade
    }
}
