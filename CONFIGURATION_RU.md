# Обзор архитектуры системы

## Высокоуровневая топология

Система развернута на **DigitalOcean** и состоит из **трех VPS-инстансов**, соединенных через **частную сеть (10.104.0.0/24)**.  
Весь **внешний входящий трафик** завершается на **vps_1**, который выступает как **единственная точка входа** во внутреннюю инфраструктуру.

---

## VPS 1 — Вход, Оркестрация, OLTP, Объектное хранилище

**Hostname / IP:** `vps_1 / 10.10.0.5`  
**OS:** Debian 12  
**Роли:**  
- Единственная внешняя точка входа  
- VPN-шлюз  
- Оркестрация рабочих процессов  
- OLTP-хранилище  
- Объектное хранилище

### Установленные сервисы
- **Docker Engine**
- **OpenVPN**

### Docker-компоненты
- **Apache Airflow**
  - Оркестрирует пакетные и аналитические рабочие процессы
- **PostgreSQL (Airflow Metadata DB)**
  - Хранит состояние Airflow, запуски DAG, экземпляры задач
- **PostgreSQL (OLTP)**
  - Основная транзакционная база данных для приложений
- **S3-совместимое объектное хранилище**
  - Централизованное хранилище для сырых и промежуточных данных
  - Используется Airflow и Spark-заданиями

### Обязанности
- Завершает весь входящий интернет-трафик
- Предоставляет безопасный VPN-доступ к частной сети
- Выступает как узел управления и координации

---

## VPS 2 — Распределенный вычислительный слой

**Hostname / IP:** `vps_2 / 10.104.0.3`  
**OS:** Debian 12  
**Роли:**  
- Распределенная обработка данных
- Интерактивная аналитика

### Установленные сервисы
- **Kubernetes**

### Kubernetes-нагрузки
- **Apache Spark (на Kubernetes)**
  - Пакетная и аналитическая обработка
  - Читает данные из S3-совместимого хранилища
  - Записывает результаты в ClickHouse и/или S3
- **Jupyter Notebook**
  - Интерактивная разработка и исследование
  - Интерфейс клиента Spark

### Обязанности
- Выполняет вычислительно-интенсивные нагрузки
- Изолирован от прямого доступа к интернету
- Общается только через частную сеть

---

## VPS 3 — Аналитический слой хранения

**Hostname / IP:** `vps_3 / 10.104.0.4`  
**OS:** Debian 12  
**Роли:**  
- Аналитическое хранение данных
- Обработка OLAP-запросов

### Установленные сервисы
- **Docker Engine**

### Docker-компоненты
- **ClickHouse (2 шарда)**
  - Распределенная аналитическая база данных
  - Оптимизирована для высокопроизводительных аналитических запросов

### Обязанности
- Обслуживает аналитические нагрузки
- Получает данные от Spark-заданий
- Нет прямого воздействия интернета

---

## Модель сети и безопасности

- **Единственная точка входа:** только `vps_1` открыт для интернета
- **Частная межузловая коммуникация:** `10.104.0.0/24`
- **Контроль доступа:** OpenVPN на `vps_1`
- **Нет публичного воздействия** Kubernetes, Spark или ClickHouse

---

## Сводка потока данных

1. Внешние запросы входят через **vps_1**
2. Airflow запускает задания и координирует рабочие процессы
3. Сырые/промежуточные данные хранятся в **S3-совместимом хранилище**
4. Spark-задания на **vps_2** обрабатывают данные
5. Аналитические результаты записываются в **ClickHouse на vps_3**
6. OLTP-нагрузки обрабатываются PostgreSQL на **vps_1**

---

## Архитектурные характеристики

- Четкое разделение **входа**, **вычислений** и **аналитики**
- Минимальная поверхность атаки
- Подходит для пакетной аналитики и рабочих нагрузок по инженерии данных
- Масштабируется горизонтально на уровнях вычислений и аналитики
